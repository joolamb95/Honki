<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" "https://mybatis.org/dtd/mybatis-3-mapper.dtd">

<mapper namespace="order">

	   <!-- Ï£ºÎ¨∏ ÏÉùÏÑ± -->
   <insert id="insertOrder" parameterType="order">
        INSERT INTO ORDERS (ORDER_NO, TABLE_NO, PAYMENT_ID, TOTAL_PRICE, ORDER_DATE)
        VALUES (SEQ_ORDER_NO.NEXTVAL, #{tableNo}, #{paymentId}, #{totalPrice}, SYSDATE)
    </insert>

    <!-- Î∞©Í∏à ÏÉùÏÑ±Îêú ORDER_NO Í∞ÄÏ†∏Ïò§Í∏∞ -->
    <select id="getLastOrderNo" resultType="int">
        SELECT SEQ_ORDER_NO.CURRVAL FROM DUAL
    </select>


    <!-- Ï£ºÎ¨∏ ÏóÖÎç∞Ïù¥Ìä∏ -->
    <update id="updateOrders" parameterType="order">
        UPDATE ORDERS
        SET PAYMENT_ID = #{paymentId}, TOTAL_PRICE = #{totalPrice}
        WHERE ORDER_NO = #{orderNo}
    </update>
    
	<!-- Ï†ÑÏ≤¥ ÌÖåÏù¥Î∏îÏùò Ï£ºÎ¨∏ ÎÇ¥Ïó≠ Ï°∞Ìöå (resultMap Ï†ÅÏö©) -->
	<select id="getAllOrders" resultType="OrderDetailDTO">
	    SELECT 
	        o.TABLE_NO AS tableNo, 
	        o.ORDER_NO AS orderNo, 
	        od.MENU_NO AS menuNo, 
	        m.MENU_NAME AS menuName,
	        MAX(od.AMOUNT) AS totalAmount,  
	        MAX(od.PRICE) AS totalPrice,  
	        LISTAGG(od.OPTION_NO, ', ') WITHIN GROUP (ORDER BY od.OPTION_NO) AS optionList  
	    FROM ORDERS o
	    LEFT JOIN ORDERS_DETAIL od ON o.ORDER_NO = od.ORDER_NO
	    LEFT JOIN MENU m ON od.MENU_NO = m.MENU_NO
	    WHERE od.STATUS = 'Y'
	    GROUP BY o.TABLE_NO, o.ORDER_NO, od.MENU_NO, m.MENU_NAME
	    ORDER BY o.ORDER_NO DESC
	</select>

 	<!-- ‚úÖ ÌäπÏ†ï ÌÖåÏù¥Î∏îÏùò Ï£ºÎ¨∏ ÎÇ¥Ïó≠ Ï°∞Ìöå ÏøºÎ¶¨ Ï∂îÍ∞Ä -->
	<select id="getOrdersByTable" resultMap="OrderDetailMap">
		SELECT
		    o.ORDER_NO,
		    o.TABLE_NO,
		    o.ORDER_DATE,
		    o.TOTAL_PRICE, -- üî• ÏµúÏ¢Ö Í∞ÄÍ≤©Ïù¥ÎØÄÎ°ú Î≥ÑÎèÑ ÏßëÍ≥Ñ ÌïÑÏöî ÏóÜÏùå
		    od.DETAIL_ID,
		    od.MENU_NO,
		    od.AMOUNT,
		    od.OPTION_NO,
		    m.MENU_NAME
		FROM (
		    SELECT ORDER_NO, TABLE_NO, ORDER_DATE, TOTAL_PRICE
		    FROM ORDERS
		    WHERE TABLE_NO = #{tableNo}
		) o
		JOIN ORDERS_DETAIL od ON o.ORDER_NO = od.ORDER_NO
		LEFT JOIN MENU m ON od.MENU_NO = m.MENU_NO
		LEFT JOIN MENU_OPTION mo ON od.OPTION_NO = mo.OPTION_NO
		WHERE od.STATUS = 'Y'
		ORDER BY o.ORDER_NO DESC
	</select>
	
	<!-- list Î•º ÏÇ¨Ïö©ÌïòÍ∏∞ ÏúÑÌïú resultMap -->
	<resultMap id="OrderDetailMap" type="order">
	    <id property="orderNo" column="ORDER_NO"/>
	    <result property="tableNo" column="TABLE_NO"/>
	    <result property="orderDate" column="ORDER_DATE"/>
	    <result property="totalPrice" column="TOTAL_PRICE"/>
	    
    
	    <!-- üî• Ï£ºÎ¨∏ ÏÉÅÏÑ∏ Ï†ïÎ≥¥ Î¶¨Ïä§Ìä∏ Îß§Ìïë -->
	    <collection property="orderItems" ofType="ordersDetail">
	        <id property="detailId" column="DETAIL_ID"/>
	        <result property="menuNo" column="MENU_NO"/>
	        <result property="menuName" column="MENU_NAME"/>
	        <result property="amount" column="AMOUNT"/>
	        <result property="price" column="TOTAL_PRICE"/>
	        <result property="optionNo" column="OPTION_NO"/>
	    </collection>
	</resultMap>
	
		<!-- ÏÇ≠Ï†úÌï† ÌÖåÏù¥Î∏î Î≤àÌò∏Ïóê Ìï¥ÎãπÌïòÎäî Ï£ºÎ¨∏Î≤àÌò∏Î•º Î™®Îëê Ï°∞Ìöå -->
		<select id="getOrderNosByTableNo" resultType="int">
		    SELECT ORDER_NO 
		    FROM ORDERS 
		    WHERE TABLE_NO = #{tableNo}
		</select>
		
		<!-- Ìï¥Îãπ ÌÖåÏù¥Î∏îÎ≤àÌò∏Ïóê ÏÜçÌïú Ï£ºÎ¨∏ÎÇ¥Ïó≠ ÏÜåÌîÑÌä∏ÏÇ≠Ï†ú -->
		<update id="clearOrdersByTable">
		    UPDATE ORDERS_DETAIL
		    SET STATUS = 'N'
		    
		    <where>
		    	STATUS = 'Y' AND ORDER_NO IN
		    <foreach collection="list" open="(" close=")" item="orderNo" separator=",">
			     #{orderNo}
		    </foreach>
		    </where>
		</update>
 
 	<!-- ÏÇ¨Ïû•Îãò Ï¥ù Ï£ºÎ¨∏Îüâ Ï°∞Ìöå -->
 	<select id="getTotalOrders" resultType="Integer">
    	SELECT COUNT(ORDER_NO) FROM ORDERS WHERE ORDER_DATE = SYSDATE
	</select>
	
</mapper>
